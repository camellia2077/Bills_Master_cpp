# 01\_验证模块

## 模块概述

**验证模块**是本账单管理系统接收原始账单数据后的第一道关卡。其核心职责是**读取、解析并验证原始的文本账单文件**，确保其格式符合预设规范，并对数据进行初步的清洗和计算（如金额求和），为后续的数据库插入和报告生成奠定基础。

该模块旨在：

  * 验证账单文件的结构和内容合法性。
  * 将文本格式的金额（包括需要求和的表达式）转换为标准数值。
  * 识别和验证账单中的分类信息（父标题和子标题）。
  * 收集并报告验证过程中发现的任何错误和警告。

## 核心组件

数据预处理模块主要由以下几个 C++ 类组成：

  * **`BillValidator` (验证器入口)**

      * **文件：** `validator/BillValidator.h`, `validator/BillValidator.cpp`
      * **职责：** 作为整个预处理验证流程的高层封装接口。它负责加载验证配置，协调 `BillFormatVerifier` 执行验证，并最终通过 `ValidationResult` 打印验证报告。这是外部调用预处理功能的入口点。

  * **`BillConfig` (配置加载器)**

      * **文件：** `validator/config/BillConfig.h`, `validator/config/BillConfig.cpp`
      * **职责：** 从 JSON 配置文件 (`Validator_Config.json`) 中加载并解析所有预定义的账单分类规则（包括有效的父标题及其对应的子标题）。它提供方法供其他组件查询某个标题是否合法。
      * **配置文件：** `Validator_Config.json` 包含了所有允许的账单类别，例如 `MEAL吃饭` 下包含 `meal_low`、`meal_high` 等子类别。

  * **`BillFormatVerifier` (格式验证器)**

      * **文件：** `validator/verifier/BillFormatVerifier.h`, `validator/verifier/BillFormatVerifier.cpp`
      * **职责：** 执行核心的账单文件格式验证逻辑。它采用状态机模式逐行读取账单文件，根据预设规则（由 `BillConfig` 提供）进行严格的格式检查。这是实现 `格式化验证.txt`  中大部分规则的地方。

  * **`ValidationResult` (验证结果收集器)**

      * **文件：** `validator/result/ValidationResult.h`, `validator/result/ValidationResult.cpp`
      * **职责：** 用于收集、存储和管理验证过程中发现的所有错误和警告信息。它也提供了打印详细验证报告的功能。

## 输入示例

### 2. TXT 文件的格式应该是什么样？

`txt` 账单文件遵循一个清晰的层级结构，格式如下：

* **文件头部 (必须)**:
    1.  第一行必须是 `DATE:YYYYMM` 格式的日期。
    2.  第二行必须是以 `REMARK:` 开头的备注。
* **账单主体 (可重复)**:
    * **父标题**: 由全大写字母和中文组成，独占一行 (例如 `MEAL吃饭`)。
    * **子标题**: 由小写字母和下划线组成，独占一行 (例如 `meal_low`)。
    * **内容行**:
        * 格式为 `金额 描述` 或 `金额 描述(注释)`。
        * `金额` 可以是单个数字，也可以是多个数字用 `+` 连接的求和表达式 (例如 `10.97+20.97`)。
        * `描述` 是紧跟在金额后的文本。
        * `注释` 是可选的，必须用英文半角括号 `()` 包裹。

### 3. `//` 代表了什么？

在内容行中，**用 `//` 文本代表该条消费记录的“注释（comment）”**。

* **作用**: 用于记录一些额外的、非描述性的信息，例如“不好用”、“下次再买”等。
* **处理**: 在程序将 `txt` 转换为 `json` 的过程中，括号内的文本会被提取出来，并存放到 `comment` 字段中。


本模块处理的原始账单文件遵循特定的文本格式。以下是一个典型的输入账单文件 `原始数据202501.txt`  的示例，它将在预处理模块中被读取和验证：

```
DATE:202501
REMARK:
MEAL吃饭
meal_low
415.53饭
meal_high
10.97+20.97+30德克士//我是注释
85.43肯德基
meal_drink
95.20瑞幸
46.30蜜雪冰城
meal_snacks
16.99甜点
89.70冰激凌
meal_fruits
47.77菠萝
10.97西瓜

PURCHASE购物
purchase_toys
570.38乐高

DAILY日常
daily_fees
27.35哈喽
daily_consumables
6.53牙膏

WEB网络
web_service
29.80迅雷
web_game
30.00游戏月卡
```